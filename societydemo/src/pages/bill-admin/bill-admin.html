<!--
  Generated template for the BillAdminPage page.

  See http://ionicframework.com/docs/components/#navigation for more info on
  Ionic pages and navigation.
-->
<ion-header>

  <ion-navbar color="navbar">
    <ion-title>bill-admin</ion-title>
  </ion-navbar>

</ion-header>

<ion-content padding class="bg-masters">
        <h2>Invoice # <input type="text" value="001.13"></h2>

        <p>
          <label for="date">Invoice Date</label>
          <input type="date" value="">
        </p>

      <table class="items-table">
        <thead>
          <tr>
            <th>Type</th>
            <th>Description</th>
            <th>Price</th>
            <th>Total price</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="items">
          <tr id="item-1">
            <td>
              <select name="type" id="">
                <option value="service">Service</option>
                <option value="product">Product</option>
                <option value="hour">Hour</option>
                <option value="day">Day</option>
              </select>
            </td>
            <td><input type="text" class="desc" name="description" value="" placeholder="product/service description here..."></td>
            <td><input type="number" class="price" name="price" step="0.01" value="10.00"></td>
            <td class="total-price">€ 0,00</td>
            <td><a href="#" class="delete">x</a></td>
          </tr>
        </tbody>
      </table>
      <a href="" id="addItemButton">+</a>
      <table class="invoice-totals">
        <tbody>
          <tr>
            <th>Subtotal</th>
            <td id="invoiceSubtotal">€ 0,00</td>
          </tr>
          <tr class="tax-container">
            <td colspan="2">
              <table id="taxs">
                <thead>
                  <tr>
                    <th>Tax rate</th>
                    <th>Value</th>
                  </tr>
                </thead>
                <tbody>
                </tbody>
                <tfoot>
                  <tr>
                    <th>Total Tax</th>
                    <td id="invoiceTax">€ 0,00</td>
                  </tr>
                </tfoot>
              </table>
            </td>
          </tr>
          <tr>
            <th>Total Invoice</th>
            <td id="invoiceTotal">€ 0,00</td>
          </tr>
        </tbody>
      </table>

</ion-content>
<script type="text/javascript">
  var Invoice = {
  symbol: '€',
  init: function(){
    Invoice.update();
    Invoice.uiEvent();
  },
  uiEvent: function(){

    $('#items').on('click','.delete', function(e){
      e.preventDefault();
      $(this).parent().parent().remove();
      Invoice.update();
    });

    $('#items').on('change','.price,.quantity,.tax_rate', function(e){
      Invoice.update();
    });

    $('#addItemButton').on('click', function(e){
      e.preventDefault();
      Invoice.addItem();
      Invoice.update();
    });
  },
  update: function(){
    var subtotal=0,
        taxable=0,
        taxs={},
        total=0;

    $('#items tr').each(function(){
      //$(this).css('background','#f00');

      var price = parseFloat($('.price',this).val());
      var qta = parseInt($('.quantity',this).val());
      var tax_rate = parseInt($('.tax_rate option:selected',this).val());

      var total_price = price*qta;
      subtotal += total_price;

      if(tax_rate>0){
        var tax = (total_price*tax_rate)/100;

        var tax_rate_item = taxs[tax_rate] || 0;
        taxs[tax_rate] = tax_rate_item + tax;
        taxable += tax;
      }
      $('.price',this).val(parseFloat(price).toFixed(2));
      $('.total-price',this).html('€ ' + parseFloat(total_price).toFixed(2));
    });

    $('#invoiceSubtotal').html('€ ' + parseFloat(subtotal).toFixed(2));

    $('#invoiceTax').html('€ ' + parseFloat(taxable).toFixed(2));

    total = parseFloat(subtotal)+parseFloat(taxable);
    $('#invoiceTotal').html('€ ' + parseFloat(total).toFixed(2));

    //$('#taxs').hide();
    $('#taxs tbody tr').remove();

    $.each(taxs, function(index, value) {
      var parse_value = parseFloat(value).toFixed(2)
      $('#taxs tbody').append('<tr><th>'+index+'%</th><td>€ '+parse_value+'</td></tr>');
    });
    Invoice.displayTaxs();
    Invoice.displayDelete();
  },
  addItem: function(){
    alert('test');
    var html = '<tr id="item-2"><td><select name="type" id=""><option value="service">Service</option><option value="product">Product</option><option value="hour">Hour</option><option value="day">Day</option></select></td><td><input type="text" class="desc" name="description" value="" placeholder="product/service description here..."></td><td><input type="number" class="price" name="price" step="0.01" value="0.00"></td><td><input type="number" class="quantity" name="quantity" step="1" value="1"></td><td><select name="tax" id="" class="tax_rate"><option value="">None</option><option value="21">IVA 21%</option><option value="14">IVA 14%</option></select></td><td class="total-price">€ 0,00</td><td><a href="#" class="delete">x</a></td></tr>';
    $('#items').append(html);
  },
  displayDelete: function(){
    var deleteCnt = $('.delete').size();
    if(deleteCnt > 1){
      $('.delete').show();
    }else{
      $('.delete').hide();
    }
  },
  displayTaxs: function(){
    var taxsCnt = $('#taxs tbody tr').size();
    if(taxsCnt > 0){
       $('.tax-container').show();
    }else{
      $('.tax-container').hide();
    }
  }
};
// launc
Invoice.init();
</script>
